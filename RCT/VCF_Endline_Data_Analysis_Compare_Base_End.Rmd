---
title: "VCF Endline Data Analysis - Controlling Baseline"
author: "Jonathan Karl"
date: "2024-02-22"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
---

```{r}
rm(list = ls())

# Prevent scientific notation
knitr::opts_knit$set(options(scipen=999))

# Install and load all the packages that will be used for analysis
pkgs <- c("tidyverse", "purrr", "DescTools", "naniar", "ltm", "ggalluvial", "googlesheets4", "stargazer", "ggsignif", "sandwich", "lmtest", "mice")

miss_pkgs <- pkgs[!pkgs %in% installed.packages()[,1]] # vector of missing packages
if(length(miss_pkgs)>0){
  install.packages(miss_pkgs)
}
invisible(lapply(pkgs,library,character.only=TRUE))

# Clear our memory by removing objects that are no longer needed.
rm(miss_pkgs, pkgs)
```

# Helper Functions

```{r}

## Table with relative frequencies
tblFun <- function(x){
  tbl <- sort(table(x, useNA = "always"), decreasing = T)
  res <- cbind(tbl,sort(round(prop.table(tbl)*100,2), decreasing = T))
  colnames(res) <- c('Count','Percentage')
  res
}

tblFun_II <- function(x, y){
  tbl <- table(x, y)
  res <- apply(tbl, MARGIN = 2, FUN = function(x) round(prop.table(x)*100,2))
  res
}


lm_clustered_summary <- function(m = NULL){
  model <- m
  cluster_se <- vcovCL(model, cluster = ~ B0_cluster_base)
  # Summarize the model using clustered standard errors
  summary_clustered <- coeftest(model, vcov = cluster_se)
  return(summary_clustered)
}

```

## Read Data

```{r}

baseline_data <- read.csv("Data Exports/vcf2_rct_baseline_caregivers_clean.csv")
endline_data <- read.csv("Data Exports/vcf2_rct_endline_caregivers_clean.csv")

```

## Merge Data

```{r}

baseline_endline_merged <- dplyr::left_join(endline_data, baseline_data, suffix = c("_end", "_base"), by = join_by(id == final_ID))

```


## Cleaning

```{r}

map <- c("1" = "Male", "2" = "Female", "77" = "Other (Please specify)")
endline_data$B2_gender <- unname(map[endline_data$B2_gender])

map <- c("1" = "18 years old", "2" = "18-24 years", "3" = "25-34 years", "4" = "35-44 years", "5" = "45-59 years", "6" = "60+ years")
endline_data$B3_age <- unname(map[endline_data$B3_age])

map <- c("1"= "Nairobi", "2"= "Kajiado", "3" = "Kiambu", "4"= "Machakos", "77" = "Other (Please specify)")
endline_data$B4_countylive <- unname(map[endline_data$B4_countylive])

map <- c("1" = "Single, never married", "2" = "In a relationship but not married", "3" = "Married", "4" = "Divorced or separated", "5" = "Widowed", "77" = "Other (Please specify)", "99" = "Refuse to answer")
endline_data$relationship_status <- unname(map[endline_data$relationship_status])

map <- c("1" = "Traditional African Religion", "2" = "Buddhism", "3" = "Christianity", "4" = "Hinduism", "5" = "Islam", "77" = "Other", "7" = "I do not practice any religion", "99" = "Refuse to answer")
endline_data$religion <- unname(map[endline_data$religion])

map <- c("1" = "Catholic", "2" = "Protestant", "3" = "Orthodox Church", "4" = "Seventh day Adventist", "77" = "Other")
endline_data$christianity_denomination <- unname(map[endline_data$christianity_denomination])

map <- c("1" = "0 - 5,000 KES", "2" = "5,001 - 20,000 KES", "3" = "20,001 - 50,000 KES", "4" = "50,001 - 100,000 KES", "5" = "Above 100,000 KES", "99" = "Refuse to Answer")
endline_data$income_month <- unname(map[endline_data$income_month])

```

# 0. Demographics

MERGE WITH BASELINE FOR ADDITIONAL VARIABLES

```{r}

# Demographic Vars - Single Select
demographic_vars <- c("B2_gender", "B3_age", "B4_countylive", "relationship_status", "religion", "christianity_denomination", "income_month")
demographic_vars_descriptives <- lapply(demographic_vars, function(i) tblFun(endline_data[,i]))
names(demographic_vars_descriptives) <- demographic_vars
demographic_vars_descriptives

```

# 1. Detecting Manipulation

```{r}
manipulativeness_coding <- c("1" = T, "2" = T,  "3" = T, "4" = T, "5" = F, "6" = T, "7" = F, "8" = F, "9" = T, "10" = F, "11" = T, "12" = F)
manipulative_posts <- names(manipulativeness_coding[manipulativeness_coding])
non_manipulative_posts <- names(manipulativeness_coding[!manipulativeness_coding])

hpv_specific <- c("1" = T, "2" = T,  "3" = T, "4" = F, "5" = T, "6" = F, "7" = T, "8" = T, "9" = F, "10" = F, "11" = F, "12" = F)

techniques_used <- list("1" = c("Conspiracy theory", "Emotional language use"),
                        "2" = c("Emotional language use, Conspiracy theory"),
                        "3" = c("Fake account", "Emotional Language use", "Conspiracy theories"),
                        "4" = c("Trolling"), 
                        "5" = NA,
                        "6" = c("Fake account", "Emotional Language Use", "Conspiracy Theory", "Discrediting Opponents"),
                        "7" = NA,
                        "8" = NA,
                        "9" = c("Intergroup Polarisation", "Fake Account", "Emotional Language Use"),
                        "10" = NA,
                        "11" = c("Discreding Opponents"),
                        "12" = NA)

techniques_used_num <- list("1" = c("5", "2"),
                        "2" = c("2", "5"),
                        "3" = c("4", "2", "5"),
                        "4" = c("6"), 
                        "5" = NA,
                        "6" = c("4", "2", "5", "1"),
                        "7" = NA,
                        "8" = NA,
                        "9" = c("3", "4", "2"),
                        "10" = NA,
                        "11" = c("1"),
                        "12" = NA)


posts_content <- list("1" = "The Govt. doesn't want you to know - The HPV Vaccine causes EARLY menopause in women. BE CAREFUL!!!",
                        "2" = "The HPV vaccine is part of larger, DANGEROUS program by foreign governments to stop your child from giving birth! Be scared, Be aware, Be safe!!",
                        "3" = "Vaccinated girls will never get their menstrual cycles. Spread the word - boycott the HPV vaccine now!",
                        "4" = "Protests for women's rights are actually an attempt by women to hide their own faults.", 
                        "5" = "The World Health Organisation (WHO) and Ministry of Health (MoH) recently reported that 9 Kenyan women die of cervical cancer per day.",
                        "6" = "Cityzen TV EXPOSES SCAM: NTV is refusing to report that the Government is knowingly spreading diseases through the airwaves and food supply!",
                        "7" = "A recent study by the World Health Organisation (WHO) found that the best way to protect your children from HPV is to get them vaccinated against it.",
                        "8" = "The Ministry of Health supports the use of the HPV vaccine as it can reduce the burden of cervical cancer in Kenya.",
                        "9" = "All Kenyan politicians in the government are out to steal from the common mwananchi. They don't care about us! We need to fight back! We need to voice our suffering!",
                        "10" = "The United Nations encourages countries and businesses to do their part to tackle climate change.",
                        "11" = "Airtel's bundles are expensive and the network is poor. It makes no sense to get an Airtel line.",
                        "12" = "Kenya's Interior Ministry has suspended the operations of cryptocurrency project Worldcoin due to data privacy concerns.")

```

## 1.1 Is this Post Manipulative?

```{r}
# Manipulativeness Assessment
manipulativeness_assessment <- lapply(paste0("detect_misinfo_", 1:12,"_1_end"), function(i) tblFun(baseline_endline_merged[,i]))
names(manipulativeness_assessment) <- paste(ifelse(manipulativeness_coding, "Manipulative", "Non-Manipulative"), 
                                            "-",
                                            ifelse(hpv_specific, "HPV-Specific", "Non-HPV"),
                                            "-", 
                                            posts_content, 
                                            "-",
                                            techniques_used)


manipulativeness_df <- baseline_endline_merged[,c(paste0("detect_misinfo_", 1:12,"_1_base"), paste0("detect_misinfo_", 1:12,"_1_end"), "cluster_treatment_group_base", "B0_cluster_base")] 
  
manipulativeness_df[,-26] <- manipulativeness_df[,-26] %>% 
  replace_with_na_all(condition = ~.x %in% c(88, 99))

# Manipulation Detection Score
manipulativeness_df$manipulativeness_assessment_score_1_diff <- manipulativeness_df$detect_misinfo_1_1_end - manipulativeness_df$detect_misinfo_1_1_base
manipulativeness_df$manipulativeness_assessment_score_2_diff <- manipulativeness_df$detect_misinfo_2_1_end - manipulativeness_df$detect_misinfo_2_1_base
manipulativeness_df$manipulativeness_assessment_score_3_diff <- manipulativeness_df$detect_misinfo_3_1_end - manipulativeness_df$detect_misinfo_3_1_base
manipulativeness_df$manipulativeness_assessment_score_4_diff <- manipulativeness_df$detect_misinfo_4_1_end - manipulativeness_df$detect_misinfo_4_1_base
manipulativeness_df$manipulativeness_assessment_score_5_diff <- manipulativeness_df$detect_misinfo_5_1_end - manipulativeness_df$detect_misinfo_5_1_base
manipulativeness_df$manipulativeness_assessment_score_6_diff <- manipulativeness_df$detect_misinfo_6_1_end - manipulativeness_df$detect_misinfo_6_1_base
manipulativeness_df$manipulativeness_assessment_score_7_diff <- manipulativeness_df$detect_misinfo_7_1_end - manipulativeness_df$detect_misinfo_7_1_base
manipulativeness_df$manipulativeness_assessment_score_8_diff <- manipulativeness_df$detect_misinfo_8_1_end - manipulativeness_df$detect_misinfo_8_1_base
manipulativeness_df$manipulativeness_assessment_score_9_diff <- manipulativeness_df$detect_misinfo_9_1_end - manipulativeness_df$detect_misinfo_9_1_base
manipulativeness_df$manipulativeness_assessment_score_10_diff <- manipulativeness_df$detect_misinfo_10_1_end - manipulativeness_df$detect_misinfo_10_1_base
manipulativeness_df$manipulativeness_assessment_score_11_diff <- manipulativeness_df$detect_misinfo_11_1_end - manipulativeness_df$detect_misinfo_11_1_base
manipulativeness_df$manipulativeness_assessment_score_12_diff <- manipulativeness_df$detect_misinfo_12_1_end - manipulativeness_df$detect_misinfo_12_1_base

manipulativeness_df$manipulativeness_assessment_score_base <- apply(manipulativeness_df[,1:12], MARGIN = 1, FUN = function(i) sum(i == manipulativeness_coding, na.rm = T))
manipulativeness_df$manipulativeness_assessment_score_end <- apply(manipulativeness_df[,13:24], MARGIN = 1, FUN = function(i) sum(i == manipulativeness_coding, na.rm = T))
manipulativeness_df$manipulativeness_assessment_score_diff <- apply(manipulativeness_df[,29:40], MARGIN = 1, FUN = function(i) sum(i == manipulativeness_coding, na.rm = T))



# Test Manipulativeness Effect
model <- lm(manipulativeness_assessment_score_diff ~ cluster_treatment_group_base, data = manipulativeness_df)
lm_clustered_summary(model)
manipulativeness_df %>% group_by(cluster_treatment_group_base) %>% dplyr::summarise(mean_manipulativeness_assessment_score_diff = mean(manipulativeness_assessment_score_diff, na.rm = T)/12)


# Single Effects
m1 <- lm(manipulativeness_assessment_score_1_diff ~ cluster_treatment_group_base, data = manipulativeness_df)
m2 <- lm(manipulativeness_assessment_score_2_diff ~ cluster_treatment_group_base, data = manipulativeness_df)
m3 <- lm(manipulativeness_assessment_score_3_diff ~ cluster_treatment_group_base, data = manipulativeness_df)
m4 <- lm(manipulativeness_assessment_score_4_diff ~ cluster_treatment_group_base, data = manipulativeness_df)
m5 <- lm(manipulativeness_assessment_score_5_diff ~ cluster_treatment_group_base, data = manipulativeness_df)
m6 <- lm(manipulativeness_assessment_score_6_diff ~ cluster_treatment_group_base, data = manipulativeness_df)
m7 <- lm(manipulativeness_assessment_score_7_diff ~ cluster_treatment_group_base, data = manipulativeness_df)
m8 <- lm(manipulativeness_assessment_score_8_diff ~ cluster_treatment_group_base, data = manipulativeness_df)
m9 <- lm(manipulativeness_assessment_score_9_diff ~ cluster_treatment_group_base, data = manipulativeness_df)
m10 <- lm(manipulativeness_assessment_score_10_diff ~ cluster_treatment_group_base, data = manipulativeness_df)
m11 <- lm(manipulativeness_assessment_score_11_diff ~ cluster_treatment_group_base, data = manipulativeness_df)
m12 <- lm(manipulativeness_assessment_score_12_diff ~ cluster_treatment_group_base, data = manipulativeness_df)


# Test Group Differences
manipulativeness_detection_differences_lm <- list(lm_clustered_summary(m1),
                                                  lm_clustered_summary(m2),
                                                  lm_clustered_summary(m3),
                                                  lm_clustered_summary(m4),
                                                  lm_clustered_summary(m5),
                                                  lm_clustered_summary(m6),
                                                  lm_clustered_summary(m7),
                                                  lm_clustered_summary(m8),
                                                  lm_clustered_summary(m9),
                                                  lm_clustered_summary(m10),
                                                  lm_clustered_summary(m11),
                                                  lm_clustered_summary(m12))

names(manipulativeness_detection_differences_lm) <- posts_content
manipulativeness_detection_differences_lm



```

## 1.2 What Techniques were selected?

```{r}

#### What Techniques were selected?
map <- c("1"	= "Discrediting Opponents", "2"	= "Emotional Language use", "3"	= "Increasing Polarisation between groups", "4"	= "Impersonating people through Fake Accounts", "5"	= "Spreading Conspiracy Theories", "6"	= "Evoking negative feelings through Trolling", "88" = "Don't know")

compute_techniques_selected_table <- function(post_number = 1){
  split_techniques <- str_split(endline_data[,paste0("detect_misinfo_", post_number,"_2")], " ")
  split_techniques_labelled <- lapply(split_techniques, function(i) unname(map[i]))
  n_responses <- sum(sapply(split_techniques, function(i) !any(is.na(i))))
  table_temp <- table(unlist(split_techniques_labelled))
  tbl <- sort(table_temp, decreasing = T)
  res <- cbind(tbl,sort(round(tbl/n_responses*100,2), decreasing = T))
  colnames(res) <- c('Count','Percentage')
  return(res)
  }
techniques_used_table <- lapply(1:12, function(i) compute_techniques_selected_table(post_number = i))
names(techniques_used_table) <- paste(ifelse(manipulativeness_coding, "Manipulative", "Non-Manipulative"), 
                                      "-",
                                      ifelse(hpv_specific, "HPV-Specific", "Non-HPV"),
                                      "-", 
                                      techniques_used)


###### What combinations of techniques were selected?
compute_techniques_multiselected_table <- function(post_number = 1){
  
  data_temp <- endline_data[,paste0("detect_misinfo_", post_number,"_2")]
  data_temp <- str_replace(data_temp, "1", "Discrediting,")
  data_temp <- str_replace(data_temp, "2", "Emotional,")
  data_temp <- str_replace(data_temp, "3", "Polarisation,")
  data_temp <- str_replace(data_temp, "4", "Impersonating,")
  data_temp <- str_replace(data_temp, "5", "Conspiracy,")
  data_temp <- str_replace(data_temp, "6", "Trolling,")

  n_responses <- sum(!is.na(data_temp))
  table_temp <- table(data_temp)
  tbl <- sort(table_temp, decreasing = T)
  res <- cbind(tbl,sort(round(tbl/n_responses*100,2), decreasing = T))
  colnames(res) <- c('Count','Percentage')
  return(res)
  }
techniques_used_table_multi <- lapply(1:12, function(i) compute_techniques_multiselected_table(post_number = i))
names(techniques_used_table_multi) <- paste(ifelse(manipulativeness_coding, "Manipulative", "Non-Manipulative"), 
                                      "-",
                                      ifelse(hpv_specific, "HPV-Specific", "Non-HPV"),
                                      "-", 
                                      techniques_used)



# Create Ground Truth List and Data.frame to analyse
ground_truth <- techniques_used_num
data_temp <- endline_data[,c("id", paste0("detect_misinfo_", 1:12,"_2"))]

calculate_confusion_matrix <- function(response, ground_truth) {
  id_storage <- response$final_ID
  response <- response[,-1]
  techniques <- as.character(1:6)
  confusion_matrix <- data.frame(Technique = techniques, FP = 0, TP = 0, FN = 0, TN = 0)
  
  for (technique in techniques) {
    is_true <- unlist(lapply(ground_truth, function(i) any(str_detect(i, technique))))
    is_true[is.na(is_true)] <- FALSE
    is_predicted <- str_detect(technique, unlist(response))
    is_predicted[is.na(is_predicted)] <- FALSE
    
    confusion_matrix$TP[confusion_matrix$Technique == technique] <- sum(is_true & is_predicted)
    confusion_matrix$FP[confusion_matrix$Technique == technique] <- sum(!is_true & is_predicted)
    confusion_matrix$FN[confusion_matrix$Technique == technique] <- sum(is_true & !is_predicted)
    confusion_matrix$TN[confusion_matrix$Technique == technique] <- sum(!is_true & !is_predicted)
    }
  
  confusion_matrix$FPR <- confusion_matrix$FP / (confusion_matrix$FP + confusion_matrix$TN)
  confusion_matrix$TPR <- confusion_matrix$TP / (confusion_matrix$TP + confusion_matrix$FN)
  confusion_matrix$FNR <- confusion_matrix$FN / (confusion_matrix$TP + confusion_matrix$FN)
  confusion_matrix$TNR <- confusion_matrix$TN / (confusion_matrix$TN + confusion_matrix$FP)
  
  confusion_matrix <- confusion_matrix %>% 
    dplyr::select(Technique, FPR, TPR, FNR, TNR)
  confusion_matrix$final_ID <- id_storage
  return(confusion_matrix)
}


# Apply the function to each row and each ground truth, assuming 'ID' is a column in your df
results <- lapply(1:nrow(data_temp), function(i) { calculate_confusion_matrix(data_temp[i,], ground_truth) })
final_df <- do.call(rbind, results) %>% dplyr::rename(False_Positive_Rate = FPR, True_Positive_Rate = TPR, False_Negative_Rate = FNR, True_Negative_Rate = TNR)


final_df %>% group_by(Technique) %>% summarise(FPR = paste0(round(mean(False_Positive_Rate)*100, 2), "%"),
                                               TPR = paste0(round(mean(True_Positive_Rate)*100, 2), "%"),
                                               FNR = paste0(round(mean(False_Negative_Rate)*100, 2), "%"),
                                               TNR = paste0(round(mean(True_Negative_Rate)*100, 2), "%"))

```

## 1.3 How confident are people in their choices of techniques?

```{r}

manipulation_confidence_df <- baseline_endline_merged[,c("id", "cluster_treatment_group_base", "B0_cluster_base", paste0("detect_misinfo_", 1:12,"_3_base"), paste0("detect_misinfo_", 1:12,"_3_end"))] 

manipulation_confidence_df$detect_misinfo_1_3_diff <- manipulation_confidence_df$detect_misinfo_1_3_end - manipulation_confidence_df$detect_misinfo_1_3_end
manipulation_confidence_df$detect_misinfo_2_3_diff <- manipulation_confidence_df$detect_misinfo_2_3_end - manipulation_confidence_df$detect_misinfo_2_3_end
manipulation_confidence_df$detect_misinfo_3_3_diff <- manipulation_confidence_df$detect_misinfo_3_3_end - manipulation_confidence_df$detect_misinfo_3_3_end
manipulation_confidence_df$detect_misinfo_4_3_diff <- manipulation_confidence_df$detect_misinfo_4_3_end - manipulation_confidence_df$detect_misinfo_4_3_end
manipulation_confidence_df$detect_misinfo_5_3_diff <- manipulation_confidence_df$detect_misinfo_5_3_end - manipulation_confidence_df$detect_misinfo_5_3_end
manipulation_confidence_df$detect_misinfo_6_3_diff <- manipulation_confidence_df$detect_misinfo_6_3_end - manipulation_confidence_df$detect_misinfo_6_3_end
manipulation_confidence_df$detect_misinfo_7_3_diff <- manipulation_confidence_df$detect_misinfo_7_3_end - manipulation_confidence_df$detect_misinfo_7_3_end
manipulation_confidence_df$detect_misinfo_8_3_diff <- manipulation_confidence_df$detect_misinfo_8_3_end - manipulation_confidence_df$detect_misinfo_8_3_end
manipulation_confidence_df$detect_misinfo_9_3_diff <- manipulation_confidence_df$detect_misinfo_9_3_end - manipulation_confidence_df$detect_misinfo_9_3_end
manipulation_confidence_df$detect_misinfo_10_3_diff <- manipulation_confidence_df$detect_misinfo_10_3_end - manipulation_confidence_df$detect_misinfo_10_3_end
manipulation_confidence_df$detect_misinfo_11_3_diff <- manipulation_confidence_df$detect_misinfo_11_3_end - manipulation_confidence_df$detect_misinfo_11_3_end
manipulation_confidence_df$detect_misinfo_12_3_diff <- manipulation_confidence_df$detect_misinfo_12_3_end - manipulation_confidence_df$detect_misinfo_12_3_end


############### FOR MANIPULATIVE POSTS VS. NON-MANIPULATIVE POSTS
# Average Confidence by Treatment Group for the Manipulative and non-Manipulative Posts
avg_conf <- cbind(rowMeans(manipulation_confidence_df[,paste0("detect_misinfo_", 1:12, "_3_end")][,manipulativeness_coding], na.rm = T),
                  rowMeans(manipulation_confidence_df[,paste0("detect_misinfo_", 1:12, "_3_end")][,!manipulativeness_coding], na.rm = T)) %>%
  data.frame() 

avg_conf_treatgroups <- cbind(cluster_treatment_group = manipulation_confidence_df$cluster_treatment_group, avg_conf) %>% 
  dplyr::rename(mean_conf_manip = X1, mean_conf_non_manip = X2)

# Look at results
avg_conf_treatgroups %>% 
  group_by(cluster_treatment_group) %>% 
  summarise(mean_conf_manip = mean(mean_conf_manip, na.rm = T), mean_conf_non_manip = mean(mean_conf_non_manip, na.rm = T))

# T.test
# Overall difference between manipulative posts and non-manipulative posts?
t.test(avg_conf_treatgroups$mean_conf_manip, avg_conf_treatgroups$mean_conf_non_manip)


################# Is there any difference in average confidence by treatment group?
# Difference by Treatment Group?
manipulation_confidence_df$mean_confidence_end <- rowMeans(manipulation_confidence_df %>% dplyr::select(ends_with("end")), na.rm = T)
model <- lm(mean_confidence_end ~ cluster_treatment_group_base, data = manipulation_confidence_df)
lm_clustered_summary(model)



################ How is confidence correlated with correct identification of manipulativeness?
manipulativeness_and_confidence <- cbind(manipulation_confidence_df[,paste0("detect_misinfo_", 1:12, "_3_end")], 
      manipulativeness_df[,paste0("detect_misinfo_", 1:12, "_1_end")])

## Reshape the wide dataset into long format
manipulativeness_and_confidence_long <- manipulativeness_and_confidence %>%
  pivot_longer(
    cols = ends_with("3_end"),
    names_to = "post",
    names_prefix = "confidence_post",
    values_to = "confidence"
  ) %>%
  mutate(post = substr(post, nchar(post)-7, nchar(post)-6)) %>% mutate(post = str_remove(post, "_")) %>% 
  pivot_longer(
    cols = ends_with("1_end"),
    names_to = "post_id",
    names_prefix = "identified_post",
    values_to = "identified_manipulative"
  ) %>%
  mutate(post_id = substr(post_id, nchar(post_id)-7, nchar(post_id)-6)) %>% mutate(post_id = str_remove(post_id, "_")) %>% 
  filter(post == post_id) %>%  # Ensure matching post IDs
  dplyr::select(-post_id) %>%         # Remove redundant column
  mutate(actual_manipulation = rep(manipulativeness_coding, nrow(manipulativeness_and_confidence)))  # Add the actual manipulation vector


# Add a column to check if the identification was correct
manipulativeness_and_confidence_long <- manipulativeness_and_confidence_long %>%
  mutate(correct_identification = ifelse(identified_manipulative == actual_manipulation, 1, 0))

# Calculate correlation between confidence and correct identification
cor.test(manipulativeness_and_confidence_long$confidence, manipulativeness_and_confidence_long$correct_identification)

```

################# Are people more confident if they got the techniques completely right, got all of them + false positives, got at least 1 of them correct

# Only look at the manipulative data
data_techniques_selected_manipulative_only <- baseline_endline_merged[,paste0("detect_misinfo_", 1:12,"_2_end")][,manipulativeness_coding]
data_confidence_manipulative_only <- baseline_endline_merged[,c("id", "cluster_treatment_group_base", paste0("detect_misinfo_", 1:12,"_3_end"))][,-c(1,2)][,manipulativeness_coding]


compareNA <- function(v1,v2) {
    # This function returns TRUE wherever elements are the same, including NA's,
    # and false everywhere else.
    same <- (v1 == v2)  |  (is.na(v1) & is.na(v2))
    same[is.na(same)] <- FALSE
    return(same)
   }

techniques_used_num <- list("1" = c("5 2"),
                        "2" = c("2 5"),
                        "3" = c("2 4 5"),
                        "4" = c("6"), 
                        "6" = c("1 2 4 5"),
                        "9" = c("2 3 4"),
                        "11" = c("1"))

# which ones were completely correct?
complete_correct_techniques <- t(apply(data_techniques_selected_manipulative_only, MARGIN = 1, FUN = function(i) compareNA(i, unlist(techniques_used_num))))

# Are the assessments that were completely correct more confidently made?
t.test(data_confidence_manipulative_only[complete_correct_techniques], data_confidence_manipulative_only[!complete_correct_techniques])

# Does confidence for the completely correct assessments differ by treatment group?
data_confidence_manipulative_only_ids_groups <- cbind(baseline_endline_merged[,c("id", "cluster_treatment_group_base", "B0_cluster_base")], data_confidence_manipulative_only) # Add cluster treatment group and ID to this dataset
data_confidence_manipulative_only_ids_groups[,-c(1:3)][!complete_correct_techniques] <- NA
temp <- data_confidence_manipulative_only_ids_groups %>%
  rowwise() %>% dplyr::mutate(mean_confidence = mean(dplyr::c_across(starts_with("detect_misinfo")), na.rm = TRUE)) %>% ungroup()
model <- lm(mean_confidence ~ cluster_treatment_group_base, data = temp)
lm_clustered_summary(model)

# Does confidence for the not completely correct assessments differ by id group?
data_confidence_manipulative_only_ids_groups <- cbind(baseline_endline_merged[,c("id", "cluster_treatment_group_base", "B0_cluster_base")], data_confidence_manipulative_only) # Add cluster treatment group and ID to this dataset
data_confidence_manipulative_only_ids_groups[,-c(1:3)][complete_correct_techniques] <- NA
temp <- data_confidence_manipulative_only_ids_groups %>% 
  rowwise() %>% dplyr::mutate(mean_confidence = mean(c_across(starts_with("detect_misinfo")), na.rm = TRUE)) %>% ungroup()
model <- lm(mean_confidence ~ cluster_treatment_group_base, data = temp)
lm_clustered_summary(model)

```

## 1.4 Sharing Propensity

```{r}

# Prep data
sharing_propensity <- baseline_endline_merged[,c("id", "cluster_treatment_group_base", "B0_cluster_base", paste0("detect_misinfo_", 1:12,"_4_base"), paste0("detect_misinfo_", 1:12,"_4_end"))]

# Prep variables
sharing_propensity$detect_misinfo_1_4_diff <- sharing_propensity$detect_misinfo_1_4_end - sharing_propensity$detect_misinfo_1_4_base
sharing_propensity$detect_misinfo_2_4_diff <- sharing_propensity$detect_misinfo_2_4_end - sharing_propensity$detect_misinfo_2_4_base
sharing_propensity$detect_misinfo_3_4_diff <- sharing_propensity$detect_misinfo_3_4_end - sharing_propensity$detect_misinfo_3_4_base
sharing_propensity$detect_misinfo_4_4_diff <- sharing_propensity$detect_misinfo_4_4_end - sharing_propensity$detect_misinfo_4_4_base
sharing_propensity$detect_misinfo_5_4_diff <- sharing_propensity$detect_misinfo_5_4_end - sharing_propensity$detect_misinfo_5_4_base
sharing_propensity$detect_misinfo_6_4_diff <- sharing_propensity$detect_misinfo_6_4_end - sharing_propensity$detect_misinfo_6_4_base
sharing_propensity$detect_misinfo_7_4_diff <- sharing_propensity$detect_misinfo_7_4_end - sharing_propensity$detect_misinfo_7_4_base
sharing_propensity$detect_misinfo_8_4_diff <- sharing_propensity$detect_misinfo_8_4_end - sharing_propensity$detect_misinfo_8_4_base
sharing_propensity$detect_misinfo_9_4_diff <- sharing_propensity$detect_misinfo_9_4_end - sharing_propensity$detect_misinfo_9_4_base
sharing_propensity$detect_misinfo_10_4_diff <- sharing_propensity$detect_misinfo_10_4_end - sharing_propensity$detect_misinfo_10_4_base
sharing_propensity$detect_misinfo_11_4_diff <- sharing_propensity$detect_misinfo_11_4_end - sharing_propensity$detect_misinfo_11_4_base
sharing_propensity$detect_misinfo_12_4_diff <- sharing_propensity$detect_misinfo_12_4_end - sharing_propensity$detect_misinfo_12_4_base


```


```{r}

# 1. Avg. sharing intentions ➡️ for Online, Offline & Online_Offline 
sharing_propensity$sharing_propensity_diff <- rowMeans(sharing_propensity[,paste0("detect_misinfo_", 1:12, "_4_diff")])
model <- lm(sharing_propensity_diff ~ cluster_treatment_group_base, data = sharing_propensity)
lm_clustered_summary(model)
sharing_propensity %>% group_by(cluster_treatment_group_base) %>% dplyr::summarise(mean_sharing_propensity_diff = mean(sharing_propensity_diff, na.rm = T))

###############

# Prep Data for other hypotheses
sharing_propensity_pivoted <- sharing_propensity[,c("id", "cluster_treatment_group_base", "B0_cluster_base", paste0("detect_misinfo_", 1:12,"_4_end"))] %>% 
  pivot_longer(detect_misinfo_1_4_end:detect_misinfo_12_4_end, names_to = "post_number", values_to = "sharing_propensity_end") %>% 
  mutate(post_number = str_extract(post_number, "[0-9]{1,2}"))

# Prep data for how a post was perceived
sharing_propensity_perception <- endline_data[,c("id", "cluster_treatment_group", paste0("detect_misinfo_", 1:12,"_1"))] %>% 
  pivot_longer(detect_misinfo_1_1:detect_misinfo_12_1, names_to = "post_number", values_to = "manipulativeness_perception") %>% 
  mutate(post_number = str_extract(post_number, "[0-9]{1,2}")) %>% 
  mutate(manipulativeness_perception = ifelse(manipulativeness_perception == 1, TRUE, FALSE)) %>% 
  merge(sharing_propensity_pivoted)

# Prep data for how a post was actually manipulative or not
sharing_propensity_perception$manipulativeness_actual <- manipulativeness_coding[sharing_propensity_perception$post_number]

# 2. Avg. sharing intentions for actual manipulative posts ⬇️ for Online, Offline & Online_Offline
model <- lm(sharing_propensity_end ~ cluster_treatment_group, data = sharing_propensity_perception %>% filter(post_number %in% manipulative_posts))
lm_clustered_summary(model)

# 3. Avg. sharing intentions for actual non-manipulative posts ➡️ for Online, Offline & Online_Offline
model <- lm(sharing_propensity_end ~ cluster_treatment_group, data = sharing_propensity_perception %>% filter(post_number %in% non_manipulative_posts))
lm_clustered_summary(model)

# 4. Avg. sharing intentions for perceived manipulative posts ⬇️ for Online, Offline & Online_Offline
model <- lm(sharing_propensity_end ~ cluster_treatment_group, data = sharing_propensity_perception %>% filter(manipulativeness_perception == TRUE))
lm_clustered_summary(model)

# 5. Avg. sharing intentions for correctly perceived manipulative posts ⬇️ for Online, Offline & Online_Offline
model <- lm(sharing_propensity_end ~ cluster_treatment_group, data = sharing_propensity_perception %>% filter(manipulativeness_perception == TRUE & manipulativeness_actual == TRUE))
lm_clustered_summary(model)

# 6. Avg. sharing intentions for falsely perceived manipulative posts ⬇️ for Online, Offline & Online_Offline
model <- lm(sharing_propensity_end ~ cluster_treatment_group, data = sharing_propensity_perception %>% filter(manipulativeness_perception == FALSE & manipulativeness_actual == TRUE))
lm_clustered_summary(model)

# 7. Avg. sharing intentions for correctly perceived non-manipulative posts ➡️ for Online, Offline & Online_Offline
model <- lm(sharing_propensity_end ~ cluster_treatment_group, data = sharing_propensity_perception %>% filter(manipulativeness_perception == FALSE & manipulativeness_actual == FALSE))
lm_clustered_summary(model)

# 8. Avg. sharing intentions for falsely perceived non-manipulative posts ➡️ for Online, Offline & Online_Offline
model <- lm(sharing_propensity_end ~ cluster_treatment_group, data = sharing_propensity_perception %>% filter(manipulativeness_perception == TRUE & manipulativeness_actual == FALSE))
lm_clustered_summary(model)

# 9. Avg. sharing intentions for manipulative posts where 50%+ techniques were correctly identified ⬇️ for Online, Offline & Online_Offline 
# 10. Avg. sharing intentions for manipulative posts where less than 50%+ techniques were correctly identified ⬇️ for Online, Offline & Online_Offline 
# 11. Avg. sharing intention for manipulative posts where technique X is present ⬇️ for Online, Offline & Online_Offline
# 12. Avg. sharing intention for manipulative posts where technique X is present but was not identified ➡️ for Online, Offline & Online_Offline
# 13. Avg. sharing intention for manipulative posts where technique X is present, which was identified ➡️ for Online, Offline & Online_Offline
# 14. Avg. sharing intention for manipulative posts where technique X is perceived ⬇️ for Online, Offline & Online_Offline
# 15. Avg. sharing intention for manipulative posts where technique X is perceived but was not present ➡️ for Online, Offline & Online_Offline
# 16. Avg. sharing intention for manipulative posts where technique X is perceived, which was present ➡️ for Online, Offline & Online_Offline


############## Descriptive Findings

######### Generally did people share manipulative (or perceived as manipulative posts) less? --> Yes.
sharing_propensity_perception %>% 
  group_by(manipulativeness_actual, manipulativeness_perception) %>% 
  dplyr::summarise(mean(sharing_propensity_end), n = n())

t.test(sharing_propensity_end ~ manipulativeness_perception, data = sharing_propensity_perception)
t.test(sharing_propensity_end ~ manipulativeness_actual, data = sharing_propensity_perception)


```

# 2. Discernment


```{r}

truth_discernment <- baseline_endline_merged[,c("id", "cluster_treatment_group_base", "B0_cluster_base", paste0(paste0("truth_discernment_", 1:16), rep(c("_base", "_end"), each = 16)))] 

truth_discernment[,-3] <- truth_discernment[,-3] %>% 
  replace_with_na_all(condition = ~.x %in% c(88, 99))

# Coding the responses as correct or incorrect
headlines_base_order <- c("Girls vaccinated against HPV will not get their menstrual cycles during their lifetime.",
 "The HPV vaccine exposes your child to cancer.",
 "If adolescent girls take the vaccine, they will not be able to have children",
 "HPV vaccine is part of a mass sterilisation program run by the government.",
 "Certain types of HPV can cause genital warts and cervical and penile cancer",
 "9 women die in Kenya every day due to cervical cancer ",
 "There exists plenty of scientific evidence that the HPV vaccine is safe and effective, protecting against cervical cancer",
 "The HPV vaccine does not cause infertility",
 "Wearing masks, maintaining social distancing and washing your hands is ineffective and doesn’t protect COVID-19 at all.",
 "Secondary education in Kenya is only available for children between the ages of 12 and 18.",
 "The eye scan by World coin is linked to the Illumati",
 "Microwaves cause cancer by converting the nutrients of food into cancer-causing agents.",
 "The leading causes of death in Africa are communicable diseases, mainly lower respiratory tract infections, diarrhoeal diseases, HIV/Aids, malaria and tuberculosis.",
"Safaricom is the largest telecommunications provider in Kenya. ",
"Nairobi is home to the largest slum in Africa.",
"Kenya is a member of the East African Community.")

true_false_coding <- c("1" = F, "2" = F,  "3" = F, "4" = F, "5" = T, "6" = T, "7" = T, "8" = T, "9" = F, "10" = F, "11" = F, "12" = F, "13" = T, "14" = T, "15" = T, "16" = T)

hpv_specific <- c("1" = T, "2" = T,  "3" = T, "4" = T, "5" = T, "6" = T, "7" = T, "8" = T, "9" = F, "10" = F, "11" = F, "12" = F, "13" = F, "14" = F, "15" = F, "16" = F)

truth_discernment_clean <- truth_discernment %>% 
  pivot_longer(truth_discernment_1_base:truth_discernment_16_end, names_to = "post_number", values_to = "truthfulness_rating") %>% 
  mutate(post_number = str_extract(post_number, "[0-9]{1,2}")) %>% 
  mutate(true_false = true_false_coding[post_number])

```

```{r}

# Compute the AUC
compute_auc <- function(truth_discernment = truth_discernment, true_false_coding = true_false_coding){
  # Iterate through each participant, compute hit-rate and false alarm rate at each decision-threshold --> compute AUC
  auc_all <- NULL
  for(i in 1:nrow(truth_discernment)){

    hit_rate_all_thresholds <- NULL
    false_alarm_rate_all_thresholds <- NULL
    
    for(threshold in 1:5){
      
      # Given a threshold, how did people perceive the post (true/false)
      perceived_binary_coded <- ifelse(truth_discernment[i,] > threshold, "Perceived_True", "Perceived_False")
      
      # Code the hit rate and false alarm rate
      hit_rate <- sum(ifelse(perceived_binary_coded == "Perceived_False" & true_false_coding == FALSE, 1, 0), na.rm = T)/(ncol(truth_discernment)/2)
      false_alarm_rate <- sum(ifelse(perceived_binary_coded == "Perceived_False" & true_false_coding == TRUE, 1, 0), na.rm = T)/(ncol(truth_discernment)/2)
      
      # Add hit rate and false alarm rate to vector storing them for all thresholds
      hit_rate_all_thresholds <- c(hit_rate_all_thresholds, hit_rate)
      false_alarm_rate_all_thresholds <- c(false_alarm_rate_all_thresholds, false_alarm_rate)
      
    }
    # Compute AUC and add to vector
    if(length(unique(c(false_alarm_rate_all_thresholds, hit_rate_all_thresholds))) < 4){
      auc_temp <- NA
    } else{
      auc_temp <- AUC(false_alarm_rate_all_thresholds, hit_rate_all_thresholds)
    }
    auc_all <- c(auc_all, auc_temp)
    
  }
  return(auc_all)
}



############################

# Myth specific differences
question_specific_truthfulness_diff <- function(question_number = NULL){
  truth_discernment$temp <- truth_discernment[,paste0("truth_discernment_", question_number,"_end"), drop = T] - truth_discernment[,paste0("truth_discernment_", question_number,"_base"), drop = T]
  model <- lm(temp ~ cluster_treatment_group_base, data = truth_discernment)
  x <- lm_clustered_summary(model)
  truth_discernment$temp <- NULL
  return(x)
}


```

```{r, warning=FALSE}

# Compute AUC
truth_discernment$auc_base <- compute_auc(truth_discernment[,-c(1,2)][,1:16], true_false_coding)
truth_discernment$auc_end <- compute_auc(truth_discernment[,-c(1,2)][,17:32], true_false_coding)
truth_discernment$auc_diff <- truth_discernment$auc_end - truth_discernment$auc_base

# Plot AUC Overall
hist(truth_discernment$auc_end)
summary(truth_discernment$auc_end)
hist(truth_discernment$auc_diff)

###################################

# Is there an overall effect?
model <- lm(auc_diff ~ cluster_treatment_group_base, data = truth_discernment)
lm_clustered_summary(model)
truth_discernment %>% group_by(cluster_treatment_group_base) %>% dplyr::summarise(mean_auc_diff = mean(auc_diff, na.rm = T))

# Is there a HPV specific effect
truth_discernment$auc_hpv_only_base <- compute_auc(truth_discernment[,paste0("truth_discernment_", 1:8, "_base")], true_false_coding[1:8])
truth_discernment$auc_hpv_only_end <- compute_auc(truth_discernment[,paste0("truth_discernment_", 1:8, "_end")], true_false_coding[1:8])
truth_discernment$auc_hpv_only_diff <- truth_discernment$auc_hpv_only_end - truth_discernment$auc_hpv_only_base
model <- lm(auc_hpv_only_diff ~ cluster_treatment_group_base, data = truth_discernment)
lm_clustered_summary(model)

# Is there an effect for Non-HPV
truth_discernment$auc_non_hpv_base <- compute_auc(truth_discernment[,paste0("truth_discernment_", 9:16, "_base")], true_false_coding[9:16])
truth_discernment$auc_non_hpv_end <- compute_auc(truth_discernment[,paste0("truth_discernment_", 9:16, "_end")], true_false_coding[9:16])
truth_discernment$auc_non_hpv_diff <- truth_discernment$auc_non_hpv_end - truth_discernment$auc_non_hpv_base
model <- lm(auc_non_hpv_diff ~ cluster_treatment_group_base, data = truth_discernment)
lm_clustered_summary(model)

###############

# Is there a non-health non-HPV specific effect
truth_discernment$auc_non_health_non_hpv_only_base <- compute_auc(truth_discernment[,paste0("truth_discernment_", c(10,11,14,15,16), "_base")], true_false_coding[c(10,11,14,15,16)])
truth_discernment$auc_non_health_non_hpv_only_end <- compute_auc(truth_discernment[,paste0("truth_discernment_", c(10,11,14,15,16), "_end")], true_false_coding[c(10,11,14,15,16)])
truth_discernment$auc_non_health_non_hpv_only_diff <- truth_discernment$auc_non_health_non_hpv_only_end - truth_discernment$auc_non_health_non_hpv_only_base
model <- lm(auc_non_health_non_hpv_only_diff ~ cluster_treatment_group_base, data = truth_discernment)
lm_clustered_summary(model)

# Is there an effect for health Non-HPV
# Not computable

# Is there any Myth specific differences?
myth_specific_ls <- list(question_specific_truthfulness_diff(1),
question_specific_truthfulness_diff(2),
question_specific_truthfulness_diff(3),
question_specific_truthfulness_diff(4),
question_specific_truthfulness_diff(5),
question_specific_truthfulness_diff(6),
question_specific_truthfulness_diff(7),
question_specific_truthfulness_diff(8),
question_specific_truthfulness_diff(9),
question_specific_truthfulness_diff(10),
question_specific_truthfulness_diff(11),
question_specific_truthfulness_diff(12),
question_specific_truthfulness_diff(13),
question_specific_truthfulness_diff(14),
question_specific_truthfulness_diff(15),
question_specific_truthfulness_diff(16))
names(myth_specific_ls) <- headlines_base_order
myth_specific_ls

# Do people move away from extremes (1-5)?
truth_discernment$extremes_count_base <- rowSums(sapply(truth_discernment[,paste0("truth_discernment_", 1:16, "_base")], function(i) i %in% c(1,5)))
truth_discernment$extremes_count_end <- rowSums(sapply(truth_discernment[,paste0("truth_discernment_", 1:16, "_end")], function(i) i %in% c(1,5)))
truth_discernment$extremes_count_diff <- truth_discernment$extremes_count_end - truth_discernment$extremes_count_base

model <- lm(extremes_count_diff ~ cluster_treatment_group_base, data = truth_discernment)
lm_clustered_summary(model)
truth_discernment %>% 
  group_by(cluster_treatment_group_base) %>% 
  dplyr::summarise(extremes_count_mean = mean(extremes_count_diff, na.rm = T))

# Everyone except Online_Offline moved away from the extremes
t.test(x = truth_discernment[truth_discernment$cluster_treatment_group_base == "Control",]$extremes_count_diff)
t.test(x = truth_discernment[truth_discernment$cluster_treatment_group_base == "Offline_Only",]$extremes_count_diff)
t.test(x = truth_discernment[truth_discernment$cluster_treatment_group_base == "Online_Only",]$extremes_count_diff)
t.test(x = truth_discernment[truth_discernment$cluster_treatment_group_base == "Online_Offline",]$extremes_count_diff)

```

## 2.1 Plots

```{r, include = FALSE, eval = FALSE}


pwc <- pairwise.t.test(truth_discernment$auc_diff, truth_discernment$cluster_treatment_group_base, 
                      p.adjust.method = "bonferroni",
                      pool.sd = TRUE)


# Convert the pairwise.t.test output into a data frame with the required columns
pwc_df <- as.data.frame(pwc$p.value)
y_position <- truth_discernment %>% group_by(cluster_treatment_group_base) %>% summarise(auc_diff = max(auc_diff, na.rm = T)) %>% pull(auc_diff)
pwc_df <- pwc_df %>%
  rownames_to_column(var = "group1") %>%
  pivot_longer(-group1, names_to = "group2", values_to = "p.value") %>%
  dplyr::filter(group2 == "Control") %>% 
  drop_na() %>% 
  mutate(p.value = round(p.value, 3)) %>% 
  mutate(y.position = max(y_position + 0.05)) %>% 
  add_row(group1 = "Control", group2 = "Control", p.value = 1, y.position = max(y_position) + 0.05, .before = 1)

p.stars <- c("***" = 0.001, "**" = 0.01, "*" = 0.05, "NS" = 1)

truth_discernment %>% 
  ggplot(aes(x = cluster_treatment_group_base, y = auc_diff, fill = cluster_treatment_group_base)) +
  geom_boxplot(alpha = 1) +
  geom_signif(comparisons = list(c("Control", "Online_Only"), 
                                 c("Control", "Offline_Only"), 
                                 c("Control", "Online_Offline")), 
              map_signif_level = function(p) {
                if (p < 0.001) {
                  return(paste0("p=", round(p,3), "***"))
                } else if (p < 0.01) {
                  return(paste0("p=", round(p,3),"**"))
                } else if (p < 0.05) {
                  return(paste0("p=", round(p,3),"*"))
                } else {
                  return("NS")
                }
              },
              y_position = c(0.75, 0.57, 0.66)) +
  scale_fill_manual("Treatment Group", values = c("lightgrey", "#0033A1", "#5074BF", "#B4C4E4")) +
  ylab("AUC Difference (Baseline - Endline)") + 
  xlab("") + 
  labs(title = "Truth Discernment - Overall Effects") +
  theme_minimal() +
  theme(legend.position = "none")

  

```


# 3. Source Credibility

```{r}

sources_order <- c("The Daily Nation", "Other Caregivers", "Akothee", "Your Hairdresser", "Doctors", "Ministry of Health (MOH)")
source_cred <- baseline_endline_merged[,c("id", "cluster_treatment_group_base", "B0_cluster_base", paste0("source_cred_", 1:6, "_base"), paste0("source_cred_", 1:6, "_end"))]

source_cred$source_cred_1_diff <- source_cred$source_cred_1_end - source_cred$source_cred_1_base
source_cred$source_cred_2_diff <- source_cred$source_cred_2_end - source_cred$source_cred_2_base
source_cred$source_cred_3_diff <- source_cred$source_cred_3_end - source_cred$source_cred_3_base
source_cred$source_cred_4_diff <- source_cred$source_cred_4_end - source_cred$source_cred_4_base
source_cred$source_cred_5_diff <- source_cred$source_cred_5_end - source_cred$source_cred_5_base
source_cred$source_cred_6_diff <- source_cred$source_cred_6_end - source_cred$source_cred_6_base

# Descriptive - Summary Stats
source_cred_descriptive_stats <- lapply(colnames(source_cred)[c(16:21)], function(i) summary(source_cred[,i]))
names(source_cred_descriptive_stats) <- sources_order

############## Additional Questions

# Do hairdressers enjoy more credibility than other hairdressers
t.test(source_cred$source_cred_4_diff, source_cred$source_cred_2_diff)
t.test(source_cred$source_cred_4_diff, source_cred$source_cred_1_diff)
```

```{r}
# 1. Caregivers ⬆️ for Online & Online_Offline
model <- lm(source_cred_2_diff ~ cluster_treatment_group_base, data = source_cred)
lm_clustered_summary(model)
source_cred %>% group_by(cluster_treatment_group_base) %>% summarise(mean_cred = mean(source_cred_2_diff, na.rm = T))

# 1. Doctors ⬆️ for Online & Online_Offline
model <- lm(source_cred_5_diff ~ cluster_treatment_group_base, data = source_cred)
lm_clustered_summary(model)
source_cred %>% group_by(cluster_treatment_group_base) %>% summarise(mean_cred = mean(source_cred_5_diff, na.rm = T))

# 2. Hairdressers ⬆️ for Offline & Online_Offline
model <- lm(source_cred_4_diff ~ cluster_treatment_group_base, data = source_cred)
lm_clustered_summary(model)
source_cred %>% group_by(cluster_treatment_group_base) %>% summarise(mean_cred = mean(source_cred_4_diff, na.rm = T))

# 3. Akothee ⬇️ for Online, Offline & Online_Offline
model <- lm(source_cred_3_diff ~ cluster_treatment_group_base, data = source_cred)
lm_clustered_summary(model)
source_cred %>% group_by(cluster_treatment_group_base) %>% summarise(mean_cred = mean(source_cred_3_diff, na.rm = T))

```

## 3.1 Plots

```{r}

hairdresser_lm <- lm(source_cred_4_diff ~ cluster_treatment_group_base, data = source_cred)
hairdresser_lm_clustered <- lm_clustered_summary(hairdresser_lm)


source_cred %>% group_by(cluster_treatment_group_base) %>% 
  dplyr::summarise(mean_cred = mean(source_cred_4_diff, na.rm = T)) %>% 
  ggplot() +
  geom_bar(aes(x = cluster_treatment_group_base, y = mean_cred, fill = cluster_treatment_group_base), stat = "identity", position = "dodge", colour = ifelse(c(1,hairdresser_lm_clustered[2:4,"Pr(>|t|)"]) <= 0.05, "red", "white")) +
  scale_fill_manual("Treatment Group", values = c("lightgrey", "#0033A1", "#5074BF", "#B4C4E4")) +
  ylab("Change: Level of Trust") + xlab("") + labs(title = "Level of Trust Regarding Health-Related Information in Hairdressers") +
  theme_minimal()


```

```{r, include = F, eval = F}
pwc <- pairwise.t.test(source_cred$sourc, source_cred$cluster_treatment_group, 
                      p.adjust.method = "bonferroni",
                      pool.sd = TRUE)


# Convert the pairwise.t.test output into a data frame with the required columns
pwc_df <- as.data.frame(pwc$p.value)
y_position <- source_cred %>% group_by(cluster_treatment_group) %>% summarise(source_cred_4 = max(source_cred_4, na.rm = T)) %>% pull(source_cred_4)
pwc_df <- pwc_df %>%
  rownames_to_column(var = "group1") %>%
  pivot_longer(-group1, names_to = "group2", values_to = "p.value") %>%
  dplyr::filter(group2 == "Control") %>% 
  drop_na() %>% 
  mutate(p.value = round(p.value, 3)) %>% 
  mutate(y.position = max(y_position + 0.05)) %>% 
  add_row(group1 = "Control", group2 = "Control", p.value = 1, y.position = max(y_position) + 0.05, .before = 1)

p.stars <- c("***" = 0.001, "**" = 0.01, "*" = 0.05, "NS" = 1)

source_cred %>% 
  ggplot(aes(x = cluster_treatment_group, y = source_cred_4, fill = cluster_treatment_group)) +
  geom_boxplot(alpha = 1) +
  geom_signif(comparisons = list(c("Control", "Online_Only"), 
                                 c("Control", "Offline_Only"), 
                                 c("Control", "Online_Offline")), 
              map_signif_level = function(p) {
                if (p < 0.001) {
                  return(paste0("p=", round(p,4), "***"))
                } else if (p < 0.01) {
                  return(paste0("p=", round(p,4),"**"))
                } else if (p < 0.05) {
                  return(paste0("p=", round(p,4),"*"))
                } else {
                  return("NS")
                }
              },
              y_position = c(11.5, 10, 10.75)) +
  scale_fill_manual("Treatment Group", values = c("lightgrey", "#0033A1", "#5074BF", "#B4C4E4")) +
  ylab("Level of Trust (1-10)") + 
  xlab("") + 
  labs(title = "Hairdresser Credibility (Health-Related Information) - Overall Effects") +
  theme_minimal() +
  theme(legend.position = "none")

```



# 4. Vaccine Community Experiences

```{r}

# vax_hes_1: Do leaders (religious or political leaders, teachers, health care workers) in your community support vaccinations for infants and children?
vax_comm_exp <- baseline_endline_merged[,c("id", "cluster_treatment_group_base", "B0_cluster_base", paste0("vax_hes_1", c("_base", "_end")))]

# Convert 88 to NA
vax_comm_exp$vax_hes_1_base[vax_comm_exp$vax_hes_1_base %in% c(88,99)] <- NA
vax_comm_exp$vax_hes_1_end[vax_comm_exp$vax_hes_1_end %in% c(88,99)] <- NA

# Calculate difference
vax_comm_exp$vax_hes_1_diff <- vax_comm_exp$vax_hes_1_end - vax_comm_exp$vax_hes_1_base

# 1. Descriptive Stats by treatment group (frequency tables)
tblFun(vax_comm_exp$vax_hes_1_diff)
tblFun_II(vax_comm_exp$vax_hes_1_diff, vax_comm_exp$cluster_treatment_group)

# 2. Test the difference
m1 <- lm(vax_hes_1_diff ~ cluster_treatment_group_base, data = vax_comm_exp)
lm_clustered_summary(m1)


```

# 5. Vaccine Attitudes

```{r}

vax_attitudes <- baseline_endline_merged[,c("id", "cluster_treatment_group_base", "B0_cluster_base", paste0(paste0("vax_hes_", 2:9), rep(c("_base", "_end"), each = 8)))]

# Convert 88 and 99 to NA
vax_attitudes[,-3] <- vax_attitudes[,-3] %>% 
  replace_with_na_all(condition = ~.x %in% c(88, 99))

# Compute difference for each variable
vax_attitudes$vax_hes_2_diff <- vax_attitudes$vax_hes_2_end - vax_attitudes$vax_hes_2_base
vax_attitudes$vax_hes_3_diff <- vax_attitudes$vax_hes_3_end - vax_attitudes$vax_hes_3_base
vax_attitudes$vax_hes_4_diff <- vax_attitudes$vax_hes_4_end - vax_attitudes$vax_hes_4_base
vax_attitudes$vax_hes_5_diff <- vax_attitudes$vax_hes_5_end - vax_attitudes$vax_hes_5_base
vax_attitudes$vax_hes_6_diff <- vax_attitudes$vax_hes_6_end - vax_attitudes$vax_hes_6_base
vax_attitudes$vax_hes_7_diff <- vax_attitudes$vax_hes_7_end - vax_attitudes$vax_hes_7_base
vax_attitudes$vax_hes_8_diff <- vax_attitudes$vax_hes_8_end - vax_attitudes$vax_hes_8_base
vax_attitudes$vax_hes_9_diff <- vax_attitudes$vax_hes_9_end - vax_attitudes$vax_hes_9_base

```

```{r}

vax_hes_likert_qs <- c("Childhood vaccines are effective", "Having my child vaccinated is important for the health of others in my community", "New vaccines carry more risks than older vaccines", "The information I receive about vaccines from the vaccine program is reliable and trustworthy", "Getting vaccines is a good way to protect my child from disease.", "Generally I do what my doctor or health care provider recommends about vaccines for my child", "I am concerned about serious adverse effects of vaccines", "My child does not need vaccines for diseases that are not common anymore")

vax_attitudes_descriptive <- lapply(colnames(vax_attitudes)[19:26], function(i) tblFun(vax_attitudes[,19:26][,i]))
names(vax_attitudes_descriptive) <- paste("DIFF:", vax_hes_likert_qs)


vax_attitudes %>% group_by(cluster_treatment_group_base) %>% 
  dplyr::summarise(mean_vax_hes_2_diff = mean(vax_hes_2_diff, na.rm = T),
            mean_vax_hes_3_diff = mean(vax_hes_3_diff, na.rm = T),
            mean_vax_hes_4_diff = mean(vax_hes_4_diff, na.rm = T),
            mean_vax_hes_5_diff = mean(vax_hes_5_diff, na.rm = T),
            mean_vax_hes_6_diff = mean(vax_hes_6_diff, na.rm = T),
            mean_vax_hes_7_diff = mean(vax_hes_7_diff, na.rm = T),
            mean_vax_hes_8_diff = mean(vax_hes_8_diff, na.rm = T),
            mean_vax_hes_9_diff = mean(vax_hes_9_diff, na.rm = T)) %>% 
  t()


reg1 <- lm(vax_hes_2_diff ~ cluster_treatment_group_base, data = vax_attitudes)
reg2 <- lm(vax_hes_3_diff ~ cluster_treatment_group_base, data = vax_attitudes)
reg3 <- lm(vax_hes_4_diff ~ cluster_treatment_group_base, data = vax_attitudes)
reg4 <- lm(vax_hes_5_diff ~ cluster_treatment_group_base, data = vax_attitudes)
reg5 <- lm(vax_hes_6_diff ~ cluster_treatment_group_base, data = vax_attitudes)
reg6 <- lm(vax_hes_7_diff ~ cluster_treatment_group_base, data = vax_attitudes)
reg7 <- lm(vax_hes_8_diff ~ cluster_treatment_group_base, data = vax_attitudes)
reg8 <- lm(vax_hes_9_diff ~ cluster_treatment_group_base, data = vax_attitudes)

# Test Group Differences
vax_attitudes_differences_lm <- list(lm_clustered_summary(reg1),
                                     lm_clustered_summary(reg2),
                                     lm_clustered_summary(reg3),
                                     lm_clustered_summary(reg4),
                                     lm_clustered_summary(reg5),
                                     lm_clustered_summary(reg6),
                                     lm_clustered_summary(reg7),
                                     lm_clustered_summary(reg8))

names(vax_attitudes_differences_lm) <- vax_hes_likert_qs
vax_attitudes_differences_lm


```

## 5.1 Plots

```{r}

# Labels
vax_hes_likert_qs_plot <-  c("Childhood vaccines are effective", 
                             "Having my child vaccinated is important\nfor the health of others in my community", 
                             "New vaccines carry more risks\nthan older vaccines", 
                             "The information I receive about\nvaccines from the vaccine program\nis reliable and trustworthy", 
                             "Getting vaccines is a good way to\nprotect my child from disease.", 
                             "Generally I do what my doctor or\nhealth care provider recommends\nabout vaccines for my child", 
                             "I am concerned about serious\nadverse effects of vaccines", 
                             "My child does not need vaccines for\ndiseases that are not common anymore")


# Significance indicators
regressions_ls <- list(reg1, reg2, reg3, reg4, reg5, reg6, reg7, reg8)
significance <- sapply(lapply(regressions_ls, lm_clustered_summary), function(i) i[2:4,"Pr(>|t|)"]) %>% 
  data.frame() %>% rownames_to_column("Group") %>% 
  pivot_longer(X1:X8, names_to = "names", values_to = "p.values") %>% 
  arrange(names)



# All
vax_attitudes[,c("cluster_treatment_group_base", paste0("vax_hes_", 2:9, "_diff"))] %>% 
  pivot_longer(!cluster_treatment_group_base, names_to = "vax_hes_element", values_to = "values") %>% 
  group_by(cluster_treatment_group_base, vax_hes_element) %>% 
  dplyr::summarise(mean_value = mean(values, na.rm = T), .groups = "drop") %>% 
  group_by(vax_hes_element) %>% 
  dplyr::mutate(mean_value_control = mean_value[cluster_treatment_group_base == "Control"],
         mean_value_diff_control = mean_value - mean_value_control) %>% 
  dplyr::select(-mean_value_control) %>% 
  filter(cluster_treatment_group_base != "Control") %>% 
  arrange(vax_hes_element) %>% 
  ungroup() %>% 
  mutate(p.value = significance$p.values) %>% 
  ggplot() +
  geom_bar(aes(x = vax_hes_element, y = mean_value_diff_control, fill = cluster_treatment_group_base),
           color = ifelse(significance$p.values <= 0.05, "red", "white"),
           stat = "identity", width = 0.7, position = "dodge") +
  scale_fill_manual("Treatment Group", values = c("#0033A1", "#5074BF", "#B4C4E4")) +
  scale_x_discrete(labels = c("vax_hes_2_diff" = vax_hes_likert_qs_plot[1], 
                              "vax_hes_3_diff" = vax_hes_likert_qs_plot[2],
                              "vax_hes_4_diff" = vax_hes_likert_qs_plot[3],
                              "vax_hes_5_diff" = vax_hes_likert_qs_plot[4],
                              "vax_hes_6_diff" = vax_hes_likert_qs_plot[5], 
                              "vax_hes_7_diff" = vax_hes_likert_qs_plot[6],
                              "vax_hes_8_diff" = vax_hes_likert_qs_plot[7],
                              "vax_hes_9_diff" = vax_hes_likert_qs_plot[8])) +
  ylab("Mean Change (5-point-scale)") + 
  xlab("") +
  labs(title = "Changes in Vaccine Attitudes", 
       subtitle = "Red bars indicate significant changes. \nAll changes are relative to the Control group.") +
  theme_minimal() +
  theme(plot.subtitle = element_text(color = "lightgrey")) +
  coord_flip()

  
```


# 6. Vaccine Behavioural Intentions

## 6.1 Reported Vax Status

```{r}

tblFun(baseline_endline_merged$B6a_number_base)
tblFun(baseline_endline_merged$B6a_number_end)
tblFun(baseline_endline_merged$B6a_number_end - baseline_endline_merged$B6a_number_base)

# Clean the original vax_beh_int_1 variable
baseline_endline_merged[!is.na(baseline_endline_merged$vax_beh_int_1_1_base),]$vax_beh_int_1 <- NA

x <- baseline_endline_merged[,c("id", "cluster_treatment_group_base", "B0_cluster_base", "B6a_number_base", "B6a_number_end", "vax_beh_int_1", 
                                sort(paste0(paste0("current_age_", 1:7), rep(c("_base", "_end"), each = 7))), 
                                sort(paste0(paste0("current_name_", 1:7), rep(c("_base", "_end"), each = 7))),
                                sort(paste0(paste0("vax_beh_int_1_", 1:7), rep(c("_base", "_end"), each = 7))))]

x.1 <- x %>% 
  dplyr::select(-starts_with("current_age"), -starts_with("vax_beh_int_1_")) %>% 
  pivot_longer(cols = starts_with("current_name"), names_to = "child_number", values_to = "name")
  
x.2 <- x %>%   
  dplyr::select(-starts_with("current_name"), -starts_with("vax_beh_int_1_")) %>% 
  pivot_longer(cols = starts_with("current_age"), names_to = "child_number_", values_to = "age")

x.3 <- x %>%   
  dplyr::select(-starts_with("current_name"), -starts_with("current_age")) %>% 
  pivot_longer(cols = starts_with("vax_beh_int_1_"), names_to = "_child_number_", values_to = "vax_status")

x.4 <- cbind(x.1, x.2[,c("age")], x.3[,c("vax_status")])
x.4$child_number <- str_remove(x.4$child_number, "current_[a-z]{3,4}_")
x.4$line <- sapply(str_split(x.4$child_number, "_"), function(i) i[2])
x.4$child_number <- sapply(str_split(x.4$child_number, "_"), function(i) i[1])

# Replace all 88s and 99s with NAs
x.4[,-3] <- x.4[,-3] %>% 
  replace_with_na_all(condition = ~.x %in% c(88, 99))

# If people vaccinated 1 child. Did they often vaccinate all?
x.5 <- x.4 %>% 
  group_by(id) %>%
  filter(child_number <= max(B6a_number_base) | child_number <= max(B6a_number_end)) %>%
  group_by(id, line) %>% 
  dplyr::mutate(mean_vax_status = mean(vax_status, na.rm = T)) %>% 
  ungroup() 

# Merge the vax_beh_int_1 into the observations where there is no mean vax status at baseline because the question wasn't asked
x.5$mean_vax_status_fused <- ifelse(is.nan(x.5$mean_vax_status), x.5$vax_beh_int_1, x.5$mean_vax_status)

# Format df into an analysable format and then 
x.6 <- x.5 %>% 
  group_by(id, line) %>%
  dplyr::summarise(cluster_treatment_group_base = unique(cluster_treatment_group_base), B0_cluster_base = unique(B0_cluster_base), mean_vax_status_fused = mean(mean_vax_status_fused, na.rm = T)) %>% 
  pivot_wider(names_from = line, values_from = mean_vax_status_fused, names_prefix = "mean_vax_status_") %>% 
  dplyr::mutate(mean_vax_status_diff = mean_vax_status_end - mean_vax_status_base)

################ Analysis ###################
m1 <- lm(mean_vax_status_end ~ cluster_treatment_group_base, data = x.6)
lm_clustered_summary(m1)

m1 <- lm(mean_vax_status_diff ~ cluster_treatment_group_base, data = x.6)
lm_clustered_summary(m1)


#########################################

# Prep for manual analysis (which we didn't do)
x.4_no_na_eligible_age <- x.4 %>% drop_na() %>% filter(age > 9)

#x.4_no_na_eligible_age %>% 
#  range_write(ss = "https://docs.google.com/spreadsheets/d/1EKnB7BuoN7qQE4k4Uj2JdYT9VYkgik_8XsIkzp_MQx4/edit?gid=0#gid=0",
#              range = "A1",
#              reformat = F)


#########################################

reported_vax_status <- baseline_endline_merged[,c("id", "cluster_treatment_group_base", "B0_cluster_base", "B6a_number_end", paste0("current_age_", 1:7, "_end"), paste0("vax_beh_int_1_", 1:7, "_end"), paste0("child_not_vaxxed_and_below_14_", 1:7, "_end"))] %>% 
  drop_na(any_of("child_not_vaxxed_and_below_14_1"))


# Assuming reported_vax_status is your dataset
age_long <- reported_vax_status %>%
  pivot_longer(cols = starts_with("current_age"), names_to = "child_number", values_to = "age") %>%
  mutate(child_number = str_extract(child_number, "\\d+")) %>% 
  dplyr::select(id, cluster_treatment_group_base, B0_cluster_base, child_number, age)

not_vaxxed_long <- reported_vax_status %>%
  pivot_longer(cols = starts_with("child_not_vaxxed_and_below_14"), names_to = "child_number", values_to = "child_not_vaxxed_and_below_14") %>%
  mutate(child_number = str_extract(child_number, "\\d+")) %>% 
  dplyr::select(child_not_vaxxed_and_below_14)

vax_status_long <- reported_vax_status %>%
  pivot_longer(cols = starts_with("vax_beh_int"), names_to = "child_number", values_to = "vax_status") %>%
  mutate(child_number = str_extract(child_number, "\\d+")) %>% 
  dplyr::select(vax_status)

# Join the datasets on child_number
reported_vax_status_final_long <- cbind(age_long, not_vaxxed_long, vax_status_long)

# Convert 88 and 99 to NA
reported_vax_status_final_long[,-3] <- reported_vax_status_final_long[,-3] %>% 
  replace_with_na_all(condition = ~.x %in% c(88, 99))

```

```{r}

reported_vax_status_final_long %>% 
  filter(age > 8 & age < 15) %>% 
  summarise(mean_vax_status = mean(vax_status, na.rm = T))

temp <- reported_vax_status_final_long %>% 
  filter(age > 8 & age < 15) %>% 
  group_by(id) %>% 
  dplyr::summarise(cluster_treatment_group_base, B0_cluster_base, mean_vax_status = mean(vax_status, na.rm = T), .groups = "drop")

tblFun(temp$mean_vax_status)
tblFun_II(temp$mean_vax_status, temp$cluster_treatment_group_base)
temp %>% group_by(cluster_treatment_group_base) %>% summarise(mean_vax_status = mean(mean_vax_status, na.rm = T))
temp %>% summarise(mean_vax_status = mean(mean_vax_status, na.rm = T))

model <- lm(mean_vax_status ~ cluster_treatment_group_base, data = temp)
lm_clustered_summary(model)

# Are those that are worse at identifying misinformation also less likely to have vaccinated their kids?
temp1 <- merge(temp, truth_discernment[, c("id", "auc_diff", "auc_hpv_only_diff", "auc_non_hpv_diff", "extremes_count_diff")], by = "id")
cor.test(temp1$mean_vax_status, temp1$auc_diff)
cor.test(temp1$mean_vax_status, temp1$auc_hpv_only_diff)
cor.test(temp1$mean_vax_status, temp1$auc_non_hpv_diff)
cor.test(temp1$mean_vax_status, temp1$extremes_count_diff)

```

## 6.2 Behavioural Intentions

```{r}

vax_beh_int <- baseline_endline_merged[,c("id", "cluster_treatment_group_base", "B0_cluster_base", "random_number_for_mini_treatment", paste0("vax_beh_int_", c(2:4,6), "_end"))] %>% 
  drop_na()

# "Get more information about HPV vaccine?"
model <- lm(vax_beh_int_2_end ~ cluster_treatment_group_base, data = vax_beh_int)
lm_clustered_summary(model)

# "Consider getting the vaccine?"
model <- lm(vax_beh_int_3_end ~ cluster_treatment_group_base, data = vax_beh_int)
lm_clustered_summary(model)

# "Try to get the vaccine?"
model <- lm(vax_beh_int_4_end ~ cluster_treatment_group_base, data = vax_beh_int)
lm_clustered_summary(model)

######## Mini Treatment - "Actually get the vaccine?"
mini_treatment <- vax_beh_int %>% 
  filter(cluster_treatment_group_base == "Control") %>%
  mutate(mini_treatment = factor(ifelse(random_number_for_mini_treatment > 0.5, "Yes", "No")))

model <- lm(vax_beh_int_6_end ~ mini_treatment, data = mini_treatment)
lm_clustered_summary(model)

```

